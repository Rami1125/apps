/**
 * ×§×•×“ Google Apps Script (GAS) ×©×œ× ×œ×˜×™×¤×•×œ ×‘×‘×§×©×•×ª API ××”××¤×œ×™×§×¦×™×”.
 * * ×©×™××• ×œ×‘: ×™×© ×œ×¤×¨×¡× ×§×•×‘×¥ ×–×” ×›×™×™×©×•× ××™× ×˜×¨× ×˜ (Web App) ×¢× ×’×™×©×” ××•×’×“×¨×ª ×œ-"Anyone".
 * ×”-Deployment URL ×”××ª×§×‘×œ ×”×•× ×”-API_URL ×©×‘×• ××©×ª××©×ª ×”××¤×œ×™×§×¦×™×”.
 */

// --- ×›× ×™×¡×” ×¨××©×™×ª ×œ×˜×™×¤×•×œ ×‘×‘×§×©×•×ª GET ---
function doGet(e) {
  try {
    const sheetName = e.parameter.sheet;
    
    let data;
    if (sheetName) {
      data = getSheetDataAsJson(sheetName);
    } else {
      data = getAllSheetData();
    }
    
    return ContentService.createTextOutput(JSON.stringify(data))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log("doGet Error: " + error.toString());
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: "×©×’×™××ª ×©×¨×ª (doGet): " + error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// --- ×›× ×™×¡×” ×¨××©×™×ª ×œ×˜×™×¤×•×œ ×‘×‘×§×©×•×ª POST (×”×¤×¢×•×œ×•×ª ×”×¢×™×§×¨×™×•×ª) ---
function doPost(e) {
  try {
    if (!e || !e.postData || !e.postData.contents) {
      throw new Error("Invalid POST request data. No postData found.");
    }
    const params = JSON.parse(e.postData.contents);
    const action = params.action;

    if (!action) {
       throw new Error("Action not specified in POST data.");
    }

    let responseData;

    switch(action) {
        
        case 'login':
            const customerId = params.customerId; 
            if (!customerId) {
                const receivedKeys = Object.keys(params).join(', ');
                throw new Error(`×©×’×™××”: ××–×”×” ×œ×§×•×— (customerId) ×œ× ×”×ª×§×‘×œ. ×©×“×•×ª ×©×”×ª×§×‘×œ×•: ${receivedKeys}`);
            }
            // *** ×ª×™×§×•×Ÿ ×§×¨×™×˜×™: ×©×™××•×© ×‘×©× ×”×’×™×œ×™×•×Ÿ ×”××“×•×™×§ ×œ×œ×§×•×—×•×ª ***
            const user = findUserByCustomerId(customerId, "×”×–×× ×•×ª ×××¤×œ×™×§×¦×™×” - ×œ×§×•×—×•×ª");
            
            if (user) {
                responseData = { 
                    status: 'success', 
                    user: user 
                };
            } else {
                responseData = { status: 'error', message: '××¡×¤×¨ ×œ×§×•×— ×œ× × ××¦×.' };
            }
            break;
            
        case 'getProductCatalog':
            // *** ×ª×™×§×•×Ÿ ×§×¨×™×˜×™: ×©×™××•×© ×‘×©× ×”×’×™×œ×™×•×Ÿ ×”××“×•×™×§ ×œ×§×˜×œ×•×’ ***
            const catalogData = getSheetDataAsJson("×”×–×× ×•×ª ×××¤×œ×™×§×¦×™×” - ×§×˜×œ×•×’ ××•×¦×¨×™×"); 
            responseData = { status: 'success', catalog: catalogData }; 
            break;
            
        case 'getClientOrders':
            const clientOrders = getClientOrders(params.customerId);
            responseData = { status: 'success', orders: clientOrders };
            break;

        case 'submitMaterialsOrder':
            const materialOrderDetails = params.order;
            const docId = saveMaterialOrderToSheet(materialOrderDetails);
            const materialWhatsappLink = createMaterialOrderWhatsAppLink(materialOrderDetails);
            
            responseData = { 
                status: 'success', 
                message: '×”×–×× ×ª ×—×•××¨×™× × ×©××¨×” ×•×©×•×“×¨×”.',
                newStatus: '×—×“×©×”',
                whatsappUrl: materialWhatsappLink,
                orderId: docId
            };
            break;

        case 'submitContainerOrder':
            const containerOrderDetails = params.orderDetails;
            saveContainerOrderToSheet(containerOrderDetails);
            const containerWhatsappLink = createContainerOrderWhatsAppLink(containerOrderDetails);
            responseData = {
                status: 'success',
                message: 'Container order saved.',
                whatsappUrl: containerWhatsappLink
            };
            break;

        default:
            responseData = { status: 'error', message: `×¤×¢×•×œ×” ×œ× ×ª×§×™× ×”. Action: ${action}` };
    }

    return ContentService.createTextOutput(JSON.stringify(responseData))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    Logger.log("Error in doPost: " + error.toString() + " Stack: " + error.stack);
    Logger.log("Raw postData: " + (e && e.postData ? e.postData.contents : 'No postData'));
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: "×©×’×™××ª ×©×¨×ª: " + error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// --- ×¤×•× ×§×¦×™×™×ª ×©×œ×™×¤×ª ×›×œ ×”×”×–×× ×•×ª ×©×œ ×”×œ×§×•×— ---

function getClientOrders(customerId) {
    // *** ×©××•×ª ×”×’×™×œ×™×•× ×•×ª ××•×ª×××™× ***
    const containerSheetName = "×”×–×× ×•×ª ×××¤×œ×™×§×¦×™×” - ×”×–×× ×•×ª ××›×•×œ×•×ª";
    const materialsSheetName = "×”×–×× ×•×ª ×××¤×œ×™×§×¦×™×” - ×”×–×× ×•×ª ×—×•××¨×™ ×‘× ×™×Ÿ";
    
    const containerOrders = getSheetDataAsJson(containerSheetName)
        .filter(order => String(order['××¡×¤×¨ ×œ×§×•×—']).trim() === String(customerId).trim())
        .map(order => ({ ...order, type: 'Container' }));

    const materialOrders = getSheetDataAsJson(materialsSheetName)
        .filter(order => String(order['××¡×¤×¨ ×œ×§×•×—']).trim() === String(customerId).trim())
        .map(order => ({ ...order, type: 'Material' }));

    // ××—×–×™×¨ ××ª ×›×œ ×”×”×–×× ×•×ª ×××•×—×“×•×ª
    return [...containerOrders, ...materialOrders];
}

// --- ×¤×•× ×§×¦×™×•×ª ×©××™×¨×” ×•-WhatsApp ---

function saveMaterialOrderToSheet(orderDetails) {
  // *** ×©× ×’×™×œ×™×•×Ÿ ××•×ª×× ***
  const sheetName = "×”×–×× ×•×ª ×××¤×œ×™×§×¦×™×” - ×”×–×× ×•×ª ×—×•××¨×™ ×‘× ×™×Ÿ"; 
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
  
  if (!sheet) {
      throw new Error(`Sheet '${sheetName}' not found. Please create it.`);
  }

  // ××™×—×•×“ ×¤×¨×˜×™ ××¡×¤×§×”
  const deliveryDetails = `×ª××¨×™×š: ${new Date(orderDetails.deliveryDate).toLocaleDateString('he-IL')}, ×”×•×‘×œ×”: ${orderDetails.transportType}, ×§×©×¨: ${orderDetails.contactName} (${orderDetails.contactPhone})`;

  // ×¢×™×¦×•×‘ ×¨×©×™××ª ×”×¤×¨×™×˜×™× ×œ×©××™×¨×” ×‘×’×™×œ×™×•×Ÿ
  const itemsList = orderDetails.items.map(item => {
      const quantityText = `${item.quantity} ${item["×™×—×™×“×ª ××™×“×”"] || '×™×—\''}`;
      const totalUnits = (item["×™×—' ×‘××©×˜×—"] > 1 && item["×™×—×™×“×ª ××™×“×”"] !== item["×‘×¡×™×¡"] && item["×™×—' ×‘××©×˜×—"] && item["×‘×¡×™×¡"]) ? 
          ` (×¡×”"×› ${item.quantity * item["×™×—' ×‘××©×˜×—"]} ${item["×‘×¡×™×¡"]})` : '';
      const sku = item["××§\"×˜"] && item["××§\"×˜"] !== 'N/A' ? ` (××§"×˜ ${item["××§\"×˜"]})` : '';

      return `${item["×©× ××•×¦×¨"]}${sku} - ${quantityText}${totalUnits}`;
  }).join('; '); 

  const newRow = [
    new Date(), // ×ª××¨×™×š ×§×œ×™×˜×”
    orderDetails.clientId || '',
    orderDetails.clientName || '',
    orderDetails.clientProject || '',
    orderDetails.deliveryAddress || '',
    deliveryDetails, // ×¤×¨×˜×™ ××¡×¤×§×” ×××•×—×“×™×
    itemsList, // ×¤×¨×™×˜×™× ××¤×•×¨×˜×™×
    orderDetails.notes || '',
    "×—×“×©×”", // ×¡×˜×˜×•×¡ ×¨××©×•× ×™
    "", // ×–××Ÿ ×”×’×¢×” ××©×•×¢×¨
    ""  // ×©× × ×”×’
  ];
  sheet.appendRow(newRow);

  return "MAT" + Date.now(); // ××–×”×” ×”×–×× ×” ××“×•××”
}

function createMaterialOrderWhatsAppLink(order) {
    const yourPhoneNumber = "9725XXXXXXXX"; 

    const itemsList = order.items.map((item, index) => {
        const skuText = item["××§\"×˜"] && item["××§\"×˜"] !== 'N/A' ? ` (××§"×˜ ${item["××§\"×˜"]})` : '';
        const totalUnitsText = (item["×™×—' ×‘××©×˜×—"] > 1 && item["×™×—×™×“×ª ××™×“×”"] !== item["×‘×¡×™×¡"] && item["×™×—' ×‘××©×˜×—"] && item["×‘×¡×™×¡"]) ? 
             `* (×¡×”"×› ${item.quantity * item["×™×—' ×‘××©×˜×—"]} ${item["×‘×¡×™×¡"]})` : '';
             
        const quantityText = `${item.quantity} ${item["×™×—×™×“×ª ××™×“×”"]}`;
        
        return `*${index + 1}. ${item["×©× ××•×¦×¨"]}*${skuText}\n - *×›××•×ª:* ${quantityText} ${totalUnitsText}`;
    }).join('\n');
    
    const notesText = order.notes ? `\n\n*ğŸ“ ×”×¢×¨×•×ª ×œ×§×•×—:*\n${order.notes}` : '';
    
    const whatsappMessage = encodeURIComponent(
        `*ğŸ“¦ ×”×–×× ×” ×—×“×©×” ×××¤×œ×™×§×¦×™×™×ª ×—.×¡×‘×Ÿ ğŸ§±*\n` +
        `*×¡×˜×˜×•×¡: ×—×“×©×”*\n\n` +
        `*ğŸ‘¤ ×œ×§×•×—:* ${order.clientName}\n` +
        `*ğŸ—ï¸ ×¤×¨×•×™×§×˜:* ${order.clientProject}\n` +
        `*ğŸ†” ××¡×¤×¨ ×œ×§×•×—:* ${order.clientId}\n\n` +
        `*ğŸ“ ×¤×¨×˜×™ ××¡×¤×§×”:*\n` +
        `â€¢ *×›×ª×•×‘×ª:* ${order.deliveryAddress}\n` +
        `â€¢ *××™×© ×§×©×¨:* ${order.contactName} (${order.contactPhone})\n` +
        `â€¢ *×ª××¨×™×š:* ${new Date(order.deliveryDate).toLocaleDateString('he-IL')}\n` +
        `â€¢ *×”×•×‘×œ×”:* ${order.transportType}\n\n` +
        `*ğŸ§± ×¤×¨×™×˜×™× ×©×”×•×–×× ×•:*\n${itemsList}` +
        `${notesText}`
    );
    
    return `https://wa.me/${yourPhoneNumber}?text=${whatsappMessage}`;
}

function saveContainerOrderToSheet(orderDetails) {
    // *** ×©× ×’×™×œ×™×•×Ÿ ××•×ª×× ***
    const sheetName = "×”×–×× ×•×ª ×××¤×œ×™×§×¦×™×” - ×”×–×× ×•×ª ××›×•×œ×•×ª"; 
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);

    if (!sheet) {
        throw new Error(`Sheet '${sheetName}' not found. Please create it.`);
    }

    const startDate = orderDetails.startDate ? new Date(orderDetails.startDate) : new Date();
    const endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + 10); 

    const newRow = [
        new Date(), 
        orderDetails.customerNumber || '',
        orderDetails.customerName || '',
        orderDetails.address || '',
        orderDetails.orderType || '',
        orderDetails.startDate ? startDate : '',
        orderDetails.orderType === '×”×•×¨×“×”' ? endDate : '',
        "×—×“×©×”",
        orderDetails.containerId || '',
        "", // ×–××Ÿ ×”×’×¢×” ××©×•×¢×¨
        ""  // ×©× × ×”×’
    ];
    sheet.appendRow(newRow);
}

function createContainerOrderWhatsAppLink(orderDetails) {
    const yourPhoneNumber = "9725XXXXXXXX"; 
    
    let message = `×‘×§×©×” ×—×“×©×” ×œ××›×•×œ×”:\n\n`;
    message += `*×¡×•×’ ×¤×¢×•×œ×”:* ${orderDetails.orderType}\n`;
    message += `*××œ×§×•×—:* ${orderDetails.customerName} (××¡': ${orderDetails.customerNumber})\n`;
    message += `*×›×ª×•×‘×ª:* ${orderDetails.address}\n`;

    if (orderDetails.orderType === '×”×•×¨×“×”') {
        message += `*×ª××¨×™×š ×”×ª×—×œ×”:* ${new Date(orderDetails.startDate).toLocaleDateString('he-IL')}\n`;
    } else {
        message += `*××–×”×” ××›×•×œ×” ×§×™×™××ª:* ${orderDetails.containerId || '×œ× ×¦×•×™×Ÿ'}\n`;
    }
    
    if (orderDetails.notes) {
        message += `\n*×”×¢×¨×•×ª:* ${orderDetails.notes}`;
    }

    const encodedMessage = encodeURIComponent(message);
    return `https://wa.me/${yourPhoneNumber}?text=${encodedMessage}`;
}

function findUserByCustomerId(customerId, sheetName) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
  if (!sheet) throw new Error(`Sheet '${sheetName}' not found.`);
  const data = sheet.getDataRange().getValues();
  const headers = data.shift();
  const customerIdColumnIndex = headers.indexOf("××¡×¤×¨ ×œ×§×•×—");
  if (customerIdColumnIndex === -1) {
    throw new Error(`Column "××¡×¤×¨ ×œ×§×•×—" not found in sheet "${sheetName}".`);
  };
  
  const cleanInputId = String(customerId).trim();

  for (let i = 0; i < data.length; i++) {
    const row = data[i];
    const rowCustomerId = String(row[customerIdColumnIndex]).trim();
    if (rowCustomerId === cleanInputId) {
      let user = {};
      headers.forEach((header, index) => {
        let cleanHeader = header.trim();
        if(cleanHeader) {
          user[cleanHeader] = row[index];
        }
      });
      return user;
    }
  }
  return null;
}

function getAllSheetData() {
  const sheets = SpreadsheetApp.getActiveSpreadsheet().getSheets();
  const allData = {};
  sheets.forEach(sheet => {
    const sheetName = sheet.getName();
    allData[sheetName] = getSheetDataAsJson(sheetName);
  });
  return allData;
}

function getSheetDataAsJson(sheetName) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
  if (!sheet) throw new Error(`Sheet '${sheetName}' not found.`);
  
  const data = sheet.getDataRange().getValues();
  if (data.length < 2) return [];
  const headers = data.shift().map(header => header.trim());
  return data.map(row => {
    const rowObject = {};
    headers.forEach((header, index) => {
        if(header) { 
              if (Object.prototype.toString.call(row[index]) === '[object Date]') {
                rowObject[header] = row[index].toISOString();
              } else {
                rowObject[header] = row[index];
              }
        }
    });
    return rowObject;
  }).filter(obj => obj[headers[0]] !== "" && obj[headers[0]] !== null); 
}
