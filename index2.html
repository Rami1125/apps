/**
 * קוד Google Apps Script (GAS) שלם לטיפול בבקשות API מהאפליקציה.
 * * שימו לב: יש לפרסם קובץ זה כיישום אינטרנט (Web App) עם גישה מוגדרת ל-"Anyone".
 * ה-Deployment URL המתקבל הוא ה-API_URL שבו משתמשת האפליקציה.
 */

// --- כניסה ראשית לטיפול בבקשות GET ---
function doGet(e) {
  try {
    const sheetName = e.parameter.sheet;
    
    let data;
    if (sheetName) {
      data = getSheetDataAsJson(sheetName);
    } else {
      data = getAllSheetData();
    }
    
    return ContentService.createTextOutput(JSON.stringify(data))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log("doGet Error: " + error.toString());
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: "שגיאת שרת (doGet): " + error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// --- כניסה ראשית לטיפול בבקשות POST (הפעולות העיקריות) ---
function doPost(e) {
  try {
    if (!e || !e.postData || !e.postData.contents) {
      throw new Error("Invalid POST request data. No postData found.");
    }
    const params = JSON.parse(e.postData.contents);
    const action = params.action;

    if (!action) {
       throw new Error("Action not specified in POST data.");
    }

    let responseData;

    switch(action) {
        
        case 'login':
            const customerId = params.customerId; 
            if (!customerId) {
                const receivedKeys = Object.keys(params).join(', ');
                throw new Error(`שגיאה: מזהה לקוח (customerId) לא התקבל. שדות שהתקבלו: ${receivedKeys}`);
            }
            // *** תיקון קריטי: שימוש בשם הגיליון המדויק ללקוחות ***
            const user = findUserByCustomerId(customerId, "הזמנות מאפליקציה - לקוחות");
            
            if (user) {
                responseData = { 
                    status: 'success', 
                    user: user 
                };
            } else {
                responseData = { status: 'error', message: 'מספר לקוח לא נמצא.' };
            }
            break;
            
        case 'getProductCatalog':
            // *** תיקון קריטי: שימוש בשם הגיליון המדויק לקטלוג ***
            const catalogData = getSheetDataAsJson("הזמנות מאפליקציה - קטלוג מוצרים"); 
            responseData = { status: 'success', catalog: catalogData }; 
            break;
            
        case 'getClientOrders':
            const clientOrders = getClientOrders(params.customerId);
            responseData = { status: 'success', orders: clientOrders };
            break;

        case 'submitMaterialsOrder':
            const materialOrderDetails = params.order;
            const docId = saveMaterialOrderToSheet(materialOrderDetails);
            const materialWhatsappLink = createMaterialOrderWhatsAppLink(materialOrderDetails);
            
            responseData = { 
                status: 'success', 
                message: 'הזמנת חומרים נשמרה ושודרה.',
                newStatus: 'חדשה',
                whatsappUrl: materialWhatsappLink,
                orderId: docId
            };
            break;

        case 'submitContainerOrder':
            const containerOrderDetails = params.orderDetails;
            saveContainerOrderToSheet(containerOrderDetails);
            const containerWhatsappLink = createContainerOrderWhatsAppLink(containerOrderDetails);
            responseData = {
                status: 'success',
                message: 'Container order saved.',
                whatsappUrl: containerWhatsappLink
            };
            break;

        default:
            responseData = { status: 'error', message: `פעולה לא תקינה. Action: ${action}` };
    }

    return ContentService.createTextOutput(JSON.stringify(responseData))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    Logger.log("Error in doPost: " + error.toString() + " Stack: " + error.stack);
    Logger.log("Raw postData: " + (e && e.postData ? e.postData.contents : 'No postData'));
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: "שגיאת שרת: " + error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// --- פונקציית שליפת כל ההזמנות של הלקוח ---

function getClientOrders(customerId) {
    // *** שמות הגיליונות מותאמים ***
    const containerSheetName = "הזמנות מאפליקציה - הזמנות מכולות";
    const materialsSheetName = "הזמנות מאפליקציה - הזמנות חומרי בנין";
    
    const containerOrders = getSheetDataAsJson(containerSheetName)
        .filter(order => String(order['מספר לקוח']).trim() === String(customerId).trim())
        .map(order => ({ ...order, type: 'Container' }));

    const materialOrders = getSheetDataAsJson(materialsSheetName)
        .filter(order => String(order['מספר לקוח']).trim() === String(customerId).trim())
        .map(order => ({ ...order, type: 'Material' }));

    // מחזיר את כל ההזמנות מאוחדות
    return [...containerOrders, ...materialOrders];
}

// --- פונקציות שמירה ו-WhatsApp ---

function saveMaterialOrderToSheet(orderDetails) {
  // *** שם גיליון מותאם ***
  const sheetName = "הזמנות מאפליקציה - הזמנות חומרי בנין"; 
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
  
  if (!sheet) {
      throw new Error(`Sheet '${sheetName}' not found. Please create it.`);
  }

  // איחוד פרטי אספקה
  const deliveryDetails = `תאריך: ${new Date(orderDetails.deliveryDate).toLocaleDateString('he-IL')}, הובלה: ${orderDetails.transportType}, קשר: ${orderDetails.contactName} (${orderDetails.contactPhone})`;

  // עיצוב רשימת הפריטים לשמירה בגיליון
  const itemsList = orderDetails.items.map(item => {
      const quantityText = `${item.quantity} ${item["יחידת מידה"] || 'יח\''}`;
      const totalUnits = (item["יח' במשטח"] > 1 && item["יחידת מידה"] !== item["בסיס"] && item["יח' במשטח"] && item["בסיס"]) ? 
          ` (סה"כ ${item.quantity * item["יח' במשטח"]} ${item["בסיס"]})` : '';
      const sku = item["מק\"ט"] && item["מק\"ט"] !== 'N/A' ? ` (מק"ט ${item["מק\"ט"]})` : '';

      return `${item["שם מוצר"]}${sku} - ${quantityText}${totalUnits}`;
  }).join('; '); 

  const newRow = [
    new Date(), // תאריך קליטה
    orderDetails.clientId || '',
    orderDetails.clientName || '',
    orderDetails.clientProject || '',
    orderDetails.deliveryAddress || '',
    deliveryDetails, // פרטי אספקה מאוחדים
    itemsList, // פריטים מפורטים
    orderDetails.notes || '',
    "חדשה", // סטטוס ראשוני
    "", // זמן הגעה משוער
    ""  // שם נהג
  ];
  sheet.appendRow(newRow);

  return "MAT" + Date.now(); // מזהה הזמנה מדומה
}

function createMaterialOrderWhatsAppLink(order) {
    const yourPhoneNumber = "9725XXXXXXXX"; 

    const itemsList = order.items.map((item, index) => {
        const skuText = item["מק\"ט"] && item["מק\"ט"] !== 'N/A' ? ` (מק"ט ${item["מק\"ט"]})` : '';
        const totalUnitsText = (item["יח' במשטח"] > 1 && item["יחידת מידה"] !== item["בסיס"] && item["יח' במשטח"] && item["בסיס"]) ? 
             `* (סה"כ ${item.quantity * item["יח' במשטח"]} ${item["בסיס"]})` : '';
             
        const quantityText = `${item.quantity} ${item["יחידת מידה"]}`;
        
        return `*${index + 1}. ${item["שם מוצר"]}*${skuText}\n - *כמות:* ${quantityText} ${totalUnitsText}`;
    }).join('\n');
    
    const notesText = order.notes ? `\n\n*📝 הערות לקוח:*\n${order.notes}` : '';
    
    const whatsappMessage = encodeURIComponent(
        `*📦 הזמנה חדשה מאפליקציית ח.סבן 🧱*\n` +
        `*סטטוס: חדשה*\n\n` +
        `*👤 לקוח:* ${order.clientName}\n` +
        `*🏗️ פרויקט:* ${order.clientProject}\n` +
        `*🆔 מספר לקוח:* ${order.clientId}\n\n` +
        `*📍 פרטי אספקה:*\n` +
        `• *כתובת:* ${order.deliveryAddress}\n` +
        `• *איש קשר:* ${order.contactName} (${order.contactPhone})\n` +
        `• *תאריך:* ${new Date(order.deliveryDate).toLocaleDateString('he-IL')}\n` +
        `• *הובלה:* ${order.transportType}\n\n` +
        `*🧱 פריטים שהוזמנו:*\n${itemsList}` +
        `${notesText}`
    );
    
    return `https://wa.me/${yourPhoneNumber}?text=${whatsappMessage}`;
}

function saveContainerOrderToSheet(orderDetails) {
    // *** שם גיליון מותאם ***
    const sheetName = "הזמנות מאפליקציה - הזמנות מכולות"; 
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);

    if (!sheet) {
        throw new Error(`Sheet '${sheetName}' not found. Please create it.`);
    }

    const startDate = orderDetails.startDate ? new Date(orderDetails.startDate) : new Date();
    const endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + 10); 

    const newRow = [
        new Date(), 
        orderDetails.customerNumber || '',
        orderDetails.customerName || '',
        orderDetails.address || '',
        orderDetails.orderType || '',
        orderDetails.startDate ? startDate : '',
        orderDetails.orderType === 'הורדה' ? endDate : '',
        "חדשה",
        orderDetails.containerId || '',
        "", // זמן הגעה משוער
        ""  // שם נהג
    ];
    sheet.appendRow(newRow);
}

function createContainerOrderWhatsAppLink(orderDetails) {
    const yourPhoneNumber = "9725XXXXXXXX"; 
    
    let message = `בקשה חדשה למכולה:\n\n`;
    message += `*סוג פעולה:* ${orderDetails.orderType}\n`;
    message += `*מלקוח:* ${orderDetails.customerName} (מס': ${orderDetails.customerNumber})\n`;
    message += `*כתובת:* ${orderDetails.address}\n`;

    if (orderDetails.orderType === 'הורדה') {
        message += `*תאריך התחלה:* ${new Date(orderDetails.startDate).toLocaleDateString('he-IL')}\n`;
    } else {
        message += `*מזהה מכולה קיימת:* ${orderDetails.containerId || 'לא צוין'}\n`;
    }
    
    if (orderDetails.notes) {
        message += `\n*הערות:* ${orderDetails.notes}`;
    }

    const encodedMessage = encodeURIComponent(message);
    return `https://wa.me/${yourPhoneNumber}?text=${encodedMessage}`;
}

function findUserByCustomerId(customerId, sheetName) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
  if (!sheet) throw new Error(`Sheet '${sheetName}' not found.`);
  const data = sheet.getDataRange().getValues();
  const headers = data.shift();
  const customerIdColumnIndex = headers.indexOf("מספר לקוח");
  if (customerIdColumnIndex === -1) {
    throw new Error(`Column "מספר לקוח" not found in sheet "${sheetName}".`);
  };
  
  const cleanInputId = String(customerId).trim();

  for (let i = 0; i < data.length; i++) {
    const row = data[i];
    const rowCustomerId = String(row[customerIdColumnIndex]).trim();
    if (rowCustomerId === cleanInputId) {
      let user = {};
      headers.forEach((header, index) => {
        let cleanHeader = header.trim();
        if(cleanHeader) {
          user[cleanHeader] = row[index];
        }
      });
      return user;
    }
  }
  return null;
}

function getAllSheetData() {
  const sheets = SpreadsheetApp.getActiveSpreadsheet().getSheets();
  const allData = {};
  sheets.forEach(sheet => {
    const sheetName = sheet.getName();
    allData[sheetName] = getSheetDataAsJson(sheetName);
  });
  return allData;
}

function getSheetDataAsJson(sheetName) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
  if (!sheet) throw new Error(`Sheet '${sheetName}' not found.`);
  
  const data = sheet.getDataRange().getValues();
  if (data.length < 2) return [];
  const headers = data.shift().map(header => header.trim());
  return data.map(row => {
    const rowObject = {};
    headers.forEach((header, index) => {
        if(header) { 
              if (Object.prototype.toString.call(row[index]) === '[object Date]') {
                rowObject[header] = row[index].toISOString();
              } else {
                rowObject[header] = row[index];
              }
        }
    });
    return rowObject;
  }).filter(obj => obj[headers[0]] !== "" && obj[headers[0]] !== null); 
}
