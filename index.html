<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>××–×•×¨ ××™×©×™ - ×—.×¡×‘×Ÿ</title>
    <meta name="theme-color" content="#ffffff"/>
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/2SbDgD1B/1.png">
    <link rel="icon" href="https://i.postimg.cc/2SbDgD1B/1.png">

    <!-- Fonts and Libraries -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        /* ×›×œ ×”-CSS × ×©××¨ ×›××• ×©×”×™×” */
        :root {
            --brand: #0b72b9; --accent: #ff9f1c; --bg: #f0f2f5; --card: #ffffff;
            --text-dark: #1a202c; --text-light: #4a5568; --text-muted: #718096;
            --border: #e2e8f0; --success: #38a169; --warning: #dd6b20; --danger: #e53e3e;
            --radius: 16px; --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --page-transition-duration: 0.4s;
        }

        /* ... ×›×œ ×©××¨ ×”-CSS ... */
    </style>
</head>
<body>
    <!-- ×›×œ ×”-HTML × ×©××¨ ×›××• ×©×”×™×” -->
    <div class="online-status" id="online-status"></div>
    
    <div class="app-shell" style="display: none;">
        <!-- ... ×ª×•×›×Ÿ ×”-HTML ... -->
    </div>

    <button class="help-fab" data-action="help-fab" style="display: none;">?</button>
    <div id="help-modal" class="help-modal">
        <!-- ... ×ª×•×›×Ÿ ×”-modal ... -->
    </div>
    
    <div id="splash-screen"><div id="splash-logo"><img src="https://i.postimg.cc/2SbDgD1B/1.png" alt="×œ×•×’×• ×—.×¡×‘×Ÿ" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"></div><div class="splash-loader"></div></div>
    <div id="toast-container"></div>
    <div id="modal-container" class="modal-overlay"></div>

    <script>
    (() => {
        try {
            document.addEventListener('DOMContentLoaded', () => {
                const API_URL = "https://script.google.com/macros/s/AKfycbx07zliATi8KaNVWALPQugtzCsuJ1CojF_N8-6wUE3AKY18Lho66XZplGSf8v2xdaVf/exec";
                
                let clientState = { 
                    id: null, 
                    name: null, 
                    avatar: null, 
                    orders: [], 
                    addresses: new Set(), 
                    currentHistoryFilter: 'all', 
                    productCatalog: [], 
                    materialOrder: { items: [], step: 1 },
                    lastUpdateCheck: null,
                    isOnline: navigator.onLine
                };
                
                let currentPageId = 'page-containers';
                let mapInstances = {};
                const dom = {};
                let pullStartY = null;
                let isRefreshing = false;
                
                const fieldHints = {
                    'deliveryAddress': '×›×ª×•×‘×ª ××œ××” ×•×‘×¨×•××” ×œ××ª×¨ ×”×¤×¨×•×™×§×˜, ×›×•×œ×œ ×¢×™×¨, ×¨×—×•×‘ ×•××¡×¤×¨.',
                    'deliveryDate': '× × ×œ×‘×—×•×¨ ××ª ×”×ª××¨×™×š ×”××‘×•×§×©. ×”×–×× ×•×ª ×“×—×•×¤×•×ª ×™×© ×œ×ª×× ×˜×œ×¤×•× ×™×ª.',
                    'contactName': '×©× ××œ× ×©×œ ××™×© ×§×©×¨ ×–××™×Ÿ ×‘××ª×¨ ×œ×¦×•×¨×š ×¤×¨×™×§×” ×•×ª×™××•×.',
                    'contactPhone': '××¡×¤×¨ ×˜×œ×¤×•×Ÿ × ×™×™×“ ×–××™×Ÿ ×œ×§×‘×œ×ª ×©×™×—×ª ×ª×™××•× ××”× ×”×’.',
                    'transportType': '×‘×—×¨×• ×× × ×“×¨×©×ª ×”×•×‘×œ×ª ×× ×•×£ ×•×›××” ××˜×¨×™× × ×“×¨×©×™× ×œ×¤×¨×™×§×”.',
                    'product-search': '×—×¤×© ××•×¦×¨×™× ××§×˜×œ×•×’ ××• ×”×§×œ×“ ×˜×§×¡×˜ ×—×•×¤×©×™ (××•×¦×¨, ×›××•×ª) ×•×”×§×© Enter ×œ×”×•×¡×¤×”.',
                    'deliveryNotes': '×¦×™×™×Ÿ ×›××Ÿ ×“×’×©×™× ××™×•×—×“×™× ×œ×¤×¨×™×§×” (×§×•××”, ×¦×“, ×’×™×©×”).',
                };
                
                let activeHintTimeout;

                // ========== ×¤×•× ×§×¦×™×™×ª updateFormView - ×”×•×¢×‘×¨×” ×œ××¢×œ×” ==========
                function updateFormView() {
                    if (!dom.stepIndicators || dom.stepIndicators.length === 0) {
                        return; 
                    }
                    
                    const step = clientState.materialOrder.step;
                    
                    // Show/hide steps
                    dom.formSteps.forEach((s, i) => s.classList.toggle('hidden', i + 1 !== step));
                    
                    // Update indicators
                    dom.stepIndicators.forEach((ind, i) => {
                        ind.classList.toggle('step-active', i + 1 === step);
                    });

                    // Update buttons
                    dom.formBackBtn.style.visibility = step === 1 ? 'hidden' : 'visible';
                    dom.formNextBtn.textContent = step === 3 ? "×©×œ×— ×”×–×× ×”" : "×”×‘×";

                    if (step === 1) {
                         document.querySelectorAll('#form-step-1 input, #form-step-1 select').forEach(input => {
                            input.addEventListener('focus', () => showFieldHint(input.id, true));
                            input.addEventListener('blur', () => showFieldHint(input.id, false));
                         });
                    } else if (step === 2) {
                        renderOrderItems();
                        if (dom.productSearch.value) dom.productSearch.dispatchEvent(new Event('input'));
                        
                        dom.productSearch.addEventListener('focus', () => showFieldHint('product-search', true));
                        dom.productSearch.addEventListener('blur', () => showFieldHint('product-search', false));
                        
                    } else if (step === 3) {
                        renderOrderSummary();
                        const notesInput = document.getElementById('deliveryNotes');
                        notesInput.addEventListener('focus', () => showFieldHint('deliveryNotes', true));
                        notesInput.addEventListener('blur', () => showFieldHint('deliveryNotes', false));
                    }
                }

                // ========== ×©××¨ ×”×¤×•× ×§×¦×™×•×ª ==========
                
                function initApp() {
                    document.body.classList.add('loaded');
                    cacheDomElements();
                    updateClock();
                    setInterval(updateClock, 1000);
                    
                    setupBrowserNotifications();
                    setupOnlineStatus();
                    setupRealTimeNotifications();
                    setupPullToRefresh();
                    setupSwipeNavigation();
                    
                    const storedClientId = localStorage.getItem('saban_client_id');
                    if (storedClientId) {
                        dom.splashScreen.classList.add('loading');
                        loadClientData(storedClientId);
                        loadProductCatalog();
                    } else {
                        dom.splashScreen.style.display = 'none';
                        promptForClientId();
                    }
                }

                function cacheDomElements(){
                    Object.assign(dom, {
                        body: document.body,
                        appShell: document.querySelector('.app-shell'),
                        splashScreen: document.getElementById('splash-screen'),
                        pages: document.querySelectorAll('.page'),
                        navButtons: document.querySelectorAll('.nav-btn'),
                        modalContainer: document.getElementById('modal-container'),
                        toastContainer: document.getElementById('toast-container'),
                        activeOrdersContainer: document.getElementById('active-orders-container'),
                        containersList: document.getElementById('containers-list'),
                        etaCardContainer: document.getElementById('eta-card-container'),
                        greeting: document.getElementById('greeting'),
                        clientNameHeader: document.getElementById('client-name-header'),
                        profileContainer: document.getElementById('profile-container'),
                        profileAvatar: document.getElementById('profile-avatar'),
                        clock: document.getElementById('clock'),
                        date: document.getElementById('date'),
                        helpFab: document.querySelector('.help-fab'),
                        helpModal: document.getElementById('help-modal'),
                        historyContent: document.getElementById('history-content'),
                        chatContent: document.getElementById('chat-content'),
                        materialsForm: document.getElementById('materials-order-form'),
                        formSteps: document.querySelectorAll('.form-step'),
                        stepIndicators: document.querySelectorAll('.step-indicator'),
                        formNextBtn: document.getElementById('form-next-btn'),
                        formBackBtn: document.getElementById('form-back-btn'),
                        productSearch: document.getElementById('product-search'),
                        productSuggestions: document.getElementById('product-suggestions'),
                        orderItemsContainer: document.getElementById('order-items-container'),
                        summaryDetails: document.getElementById('summary-details'),
                        summaryItems: document.getElementById('summary-items'),
                        pullIndicator: document.getElementById('pull-indicator'),
                        onlineStatus: document.getElementById('online-status'),
                        appContainer: document.getElementById('app-container')
                    });
                }
                
                // ========== ×¤×•× ×§×¦×™×•×ª × ×•×¡×¤×•×ª ==========
                
                function showFieldHint(elementId, isFocus) {
                    const input = document.getElementById(elementId);
                    const hintText = fieldHints[elementId];

                    if (!input || !hintText) return;

                    clearTimeout(activeHintTimeout);

                    if (isFocus) {
                        showToast(hintText, 'ğŸ’¡');
                        activeHintTimeout = setTimeout(() => {}, 5000);
                    }
                }
                
                function navigateForm(direction) {
                    const currentStep = clientState.materialOrder.step;
                    const newStep = currentStep + direction;
                    
                    if (direction > 0 && !validateFormStep(currentStep)) return;
                    if (newStep < 1 || newStep > 3) return;

                    clientState.materialOrder.step = newStep;
                    updateFormView();
                }

                function validateFormStep(step) {
                    const form = dom.materialsForm;
                    if (step === 1) {
                        const requiredFields = ['deliveryAddress', 'deliveryDate', 'contactName', 'contactPhone'];
                        for (const fieldId of requiredFields) {
                            if (!form[fieldId] || !form[fieldId].value.trim()) {
                                showToast(`×©×“×” ${form[fieldId].previousElementSibling.textContent} ×”×•× ×—×•×‘×”.`, 'âš ï¸');
                                form[fieldId].focus();
                                return false;
                            }
                        }
                    }
                    if (step === 2) {
                        if (clientState.materialOrder.items.length === 0) {
                            showToast("×× × ×”×•×¡×£ ×œ×¤×—×•×ª ××•×¦×¨ ××—×“ ×œ×”×–×× ×”.", 'âš ï¸');
                            return false;
                        }
                    }
                    return true;
                }

                function renderOrderItems() {
                    if (!dom.orderItemsContainer) return;
                    const items = clientState.materialOrder.items;
                    if (items.length === 0) {
                        dom.orderItemsContainer.innerHTML = `<p class="text-center text-text-muted">×”×•×¡×£ ××•×¦×¨×™× ×œ×‘×—×™×¨×ª×š</p>`;
                        return;
                    }

                    dom.orderItemsContainer.innerHTML = items.map((item, index) => {
                        const isUnidentified = item.isUnidentified;
                        const totalUnits = (item["×™×—' ×‘××©×˜×—"] > 1 && item["×™×—×™×“×ª ××™×“×”"] !== item["×‘×¡×™×¡"]) ? 
                            `(${item.quantity * item["×™×—' ×‘××©×˜×—"]} ${item["×‘×¡×™×¡"]})` : '';

                        return `
                        <div class="product-item flex items-center gap-4 p-3 border rounded-md shadow-sm ${isUnidentified ? 'unidentified' : ''}">
                            <div class="flex-grow">
                                <p class="font-bold">${item["×©× ××•×¦×¨"]} ${isUnidentified ? '<span class="text-yellow-600 font-sans text-lg" title="×¤×¨×™×˜ ×‘×˜×§×¡×˜ ×—×•×¤×©×™, ×× × ×•×•×“× ××ª ×”×¤×¨×˜×™×">âš ï¸</span>' : ''}</p>
                                <p class="text-sm text-text-muted">××§"×˜: ${item["××§\"×˜"] || '×œ× ×–×•×”×”'}</p>
                            </div>
                            <div class="text-center">
                                 <input type="number" value="${item.quantity}" min="0.1" step="any" class="form-input w-20 text-center p-1 text-base" data-index="${index}" data-action="update-quantity" onchange="window.updateItemQuantity(event)">
                                 <p class="text-xs text-text-muted mt-1">${item["×™×—×™×“×ª ××™×“×”"] || '×™×—\''}</p>
                            </div>
                            <button class="text-red-500 hover:text-red-700 p-2" data-index="${index}" data-action="remove-item">&times;</button>
                        </div>
                        ${totalUnits ? `<p class="text-sm text-brand font-semibold text-left -mt-2 mr-4">${totalUnits}</p>` : ''}
                        `;
                    }).join('');
                }
                
                window.updateItemQuantity = (e) => {
                    const index = e.target.dataset.index;
                    const newQuantity = parseFloat(e.target.value);
                    if(index !== undefined && newQuantity > 0) {
                        clientState.materialOrder.items[index].quantity = newQuantity;
                        renderOrderItems();
                    } else if (newQuantity <= 0) {
                        removeItemFromOrder(parseInt(index));
                    }
                };

                function removeItemFromOrder(index) {
                    clientState.materialOrder.items.splice(index, 1);
                    renderOrderItems();
                }

                function renderOrderSummary() {
                    const form = dom.materialsForm;
                    const deliveryDate = form.deliveryDate.value ? new Date(form.deliveryDate.value).toLocaleDateString('he-IL') : '×œ× ×¦×•×™×Ÿ';
                    const contactPerson = form.contactName.value || '×œ× ×¦×•×™×Ÿ';
                    const contactPhone = form.contactPhone.value || '×œ× ×¦×•×™×Ÿ';
                    
                    dom.summaryDetails.innerHTML = `
                        <p><strong>×œ×§×•×—:</strong> ${clientState.name}</p>
                        <p><strong>×¤×¨×•×™×§×˜:</strong> ${clientState.orders.find(o => o['×ª×¢×•×“×”'] == clientState.orders[0]['×ª×¢×•×“×”'])?.['×¤×¨×•×™×™×§×˜'] || '×¤×¨×•×™×§×˜ ×¨××©×™'}</p>
                        <p><strong>×›×ª×•×‘×ª:</strong> ${form.deliveryAddress.value}</p>
                        <p><strong>×ª××¨×™×š ××¡×¤×§×”:</strong> ${deliveryDate}</p>
                        <p><strong>×¡×•×’ ×”×•×‘×œ×”:</strong> ${form.transportType.value}</p>
                        <p><strong>××™×© ×§×©×¨:</strong> ${contactPerson} (${contactPhone})</p>
                    `;
                    
                    dom.summaryItems.innerHTML = clientState.materialOrder.items.map(item => {
                        const totalUnitsText = (item["×™×—' ×‘××©×˜×—"] > 1 && item["×™×—×™×“×ª ××™×“×”"] !== item["×‘×¡×™×¡"]) ? 
                            `(${item.quantity * item["×™×—' ×‘××©×˜×—"]} ${item["×‘×¡×™×¡"]})` : '';

                        return `
                        <div class="flex justify-between items-center text-sm ${item.isUnidentified ? 'text-yellow-600' : 'text-text-dark'}">
                            <span class="font-semibold">${item["×©× ××•×¦×¨"]} ${item.isUnidentified ? 'âš ï¸' : ''}</span>
                            <span class="font-bold">${item.quantity} ${item["×™×—×™×“×ª ××™×“×”"] || '×™×—\''} ${totalUnitsText}</span>
                        </div>
                    `;
                    }).join('');
                    
                    form.deliveryNotes.value = form.deliveryNotes.value || ''; 
                }

                // ========== ×©××¨ ×”×¤×•× ×§×¦×™×•×ª × ×©××¨×•×ª ×›××• ×©×”×™×• ==========
                
                function setupBrowserNotifications() {
                    if ("Notification" in window && Notification.permission === "default") {
                        Notification.requestPermission().then(permission => {
                            if (permission === "granted") {
                                showToast("×”×ª×¨××•×ª ×”×•×¤×¢×œ×• âœ…", "ğŸ””");
                            }
                        });
                    }
                }
                
                // ... (×›×œ ×©××¨ ×”×¤×•× ×§×¦×™×•×ª × ×©××¨×•×ª ×œ×œ× ×©×™× ×•×™)

                // ========== ××ª×—×•×œ ×¡×•×¤×™ ==========
                
                // âœ… ×”×ª×™×§×•×Ÿ: ×§×¨×™××” ×œ×¤×•× ×§×¦×™×” ×œ××—×¨ ×©×”×•×’×“×¨×”
                clientState.materialOrder.step = 1;
                
                // ××ª×—×•×œ ×”××¤×œ×™×§×¦×™×”
                initApp();
                
                // âœ… ×§×¨×™××” ×œ-updateFormView ×œ××—×¨ ×©×”×“×£ × ×˜×¢×Ÿ ×•×”××œ×× ×˜×™× ×§×™×™××™×
                setTimeout(() => {
                    if (dom.stepIndicators && dom.stepIndicators.length > 0) {
                        updateFormView();
                    }
                }, 100);
            });
        } catch (e) {
            document.body.innerHTML = `<div style="padding: 20px; text-align: center;"><h1>××¤×œ×™×§×¦×™×” × ×ª×§×œ×” ×‘×©×’×™××” ×—××•×¨×”</h1><p>× ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.</p></div>`
            console.error("Critical application error:", e);
        }
    })();
    </script>
</body>
</html>
